name: Nightly

on:
  push:
    branches: [develop]
    paths-ignore:
      - '*.md'
      - 'LICENSE'

permissions:
  contents: write

jobs:
  nightly:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Vet
        run: go vet ./...

      - name: Build all platforms
        run: |
          VERSION=$(cat VERSION)-nightly.$(date +%Y%m%d)
          echo "VERSION=${VERSION}" >> "$GITHUB_ENV"
          mkdir -p dist

          platforms=(
            "linux/amd64"
            "linux/arm64"
            "darwin/amd64"
            "darwin/arm64"
            "windows/amd64"
          )

          for pair in "${platforms[@]}"; do
            GOOS=${pair%/*}
            GOARCH=${pair#*/}
            EXT=""
            if [ "$GOOS" = "windows" ]; then EXT=".exe"; fi
            BINARY="simpleagent-${GOOS}-${GOARCH}${EXT}"
            echo "Building ${BINARY}..."
            GOOS=$GOOS GOARCH=$GOARCH go build -ldflags "-s -w -X main.version=${VERSION}" -o "dist/${BINARY}" .
          done

      - name: Generate checksums
        run: cd dist && sha256sum * > checksums.txt

      - name: Update nightly release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Delete existing nightly release if present
          gh release delete nightly --yes --cleanup-tag 2>/dev/null || true

          # Create new nightly pre-release
          gh release create nightly \
            --prerelease \
            --target develop \
            --title "Nightly (${VERSION})" \
            --notes "Automated nightly build from \`develop\` branch.

          **Version**: \`${VERSION}\`
          **Commit**: [\`${GITHUB_SHA::8}\`](https://github.com/${{ github.repository }}/commit/${GITHUB_SHA})
          **Date**: $(date -u +%Y-%m-%d\ %H:%M\ UTC)

          > Pre-release build â€” not recommended for production. For stable releases, use the latest tagged version." \
            dist/*
